#!/usr/bin/env groovy

/*
This is customized pipeline for running on jenkins-dirac.web.cern.ch
For testing the PilotWrapper.
*/


properties([parameters([string(name: 'DIRAC_test_repo', defaultValue: 'DIRACGrid', description: 'The DIRAC repo to use for getting the test code'),
                        string(name: 'DIRAC_test_branch_or_tag', defaultValue: 'rel-v7r0', description: 'The DIRAC branch or tag to use for getting the test code')
                       ])])

stage('Test') {

    parallel(

        "cernVM" : {
            node('lhcbci-cernvm04') {

                cleanWs()

                try {
                    // get the code, then execute:
                    // python Test_GenerateAndExecutePilotWrapper.py file://PilotWrapper.py file://dirac-install.py
                    sh '''
                        bash -c "echo HERE"
                    '''
                } catch (e) {
                    // if any exception occurs, mark the build as failed
                    currentBuild.result = 'FAILURE'
                    throw e
                } finally {
                    // perform workspace cleanup only if the build have passed
                    // if the build has failed, the workspace will be kept
                    cleanWs cleanWhenFailure: false
                }
            }
        },

        "cernVM4" : {
            node('lhcbci-cernvm4-01') {

                cleanWs()

                try {
                    sh '''
                        bash -c "echo HERE"
                    '''
                } catch (e) {
                    // if any exception occurs, mark the build as failed
                    currentBuild.result = 'FAILURE'
                    throw e
                } finally {
                    // perform workspace cleanup only if the build have passed
                    // if the build has failed, the workspace will be kept
                    cleanWs cleanWhenFailure: false
                }
            }
        }
    )
}
